<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Config Manager</title>
    <style>
        body { font-family: sans-serif; margin: 50px; line-height: 1.6; max-width: 600px; }
        .section { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        /* é»˜è®¤éšè—æ“ä½œåŒºåŸŸ */
        #actionArea { display: none; margin-top: 30px; border-top: 2px dashed #ccc; padding-top: 20px; }
        .status-msg { font-size: 0.9em; color: #666; }
        button { cursor: pointer; padding: 6px 12px; border-radius: 4px; border: 1px solid #999; }
        input[type="password"] { padding: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>é…ç½®ä¸­å¿ƒ</h1>

  <p>ç°åœ¨IPï¼š{{ ip }}</p>

    <div class="section" style="background-color: #f4f4f4;">
        <h2>ğŸ” è®¿é—®æˆæƒ</h2>
        <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥æ ¡éªŒå¯†ç ">
        <button onclick="savePassword()">ä¿å­˜å¹¶è§£é”</button>
        <button onclick="clearPassword()" style="background: #eee; border-color: #ccc;">æ¸…é™¤å­˜å‚¨</button>
        <p class="status-msg" id="statusText">å½“å‰çŠ¶æ€ï¼šæœªè§£é”</p>
    </div>

    <div id="actionArea">
        <div class="section">
            <h2>1. è·å–é…ç½®æ–‡ä»¶</h2>
            <button onclick="handleDownload()">ç‚¹å‡»ä¸‹è½½</button>
        </div>

        <div class="section">
            <h2>2. ä¸Šä¼ é…ç½®æ–‡ä»¶</h2>
            <input type="file" id="fileInput" accept=".json"> <br/>
            <button onclick="handleUpload()" style="margin-top: 4px;" >ä¸Šä¼ å¹¶è¦†ç›–</button>
        </div>

        <div class="section">
            <h2>3. é‡å¯ä»£ç†æœåŠ¡</h2>
            <button onclick="handleRestart()" >é‡å¯ä»£ç†</button>
        </div>

    </div>

    <script>
        const statusText = document.getElementById('statusText');
        const actionArea = document.getElementById('actionArea');
        const pwdInput = document.getElementById('passwordInput');

        function updateUI() {
            const savedPwd = localStorage.getItem('config_token');
            if (savedPwd && savedPwd.trim() !== "") {
                actionArea.style.display = 'block';
                statusText.innerText = "å½“å‰çŠ¶æ€ï¼šå·²è§£é”";
                statusText.style.color = "green";
                pwdInput.value = savedPwd;
            } else {
                actionArea.style.display = 'none';
                statusText.innerText = "å½“å‰çŠ¶æ€ï¼šæœªè§£é”";
                statusText.style.color = "red";
                pwdInput.value = "";
            }
        }

        function savePassword() {
            const pwd = pwdInput.value;
            if (!pwd) {
                alert("è¯·è¾“å…¥å¯†ç åå†ä¿å­˜");
                return;
            }
            localStorage.setItem('config_token', pwd);
            updateUI();
        }

        function clearPassword() {
            localStorage.removeItem('config_token');
            updateUI();
        }

        window.onload = updateUI;

        function handleDownload() {
            const token = localStorage.getItem('config_token');
            window.location.href = `/download?token=${encodeURIComponent(token)}`;
        }

        async function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const token = localStorage.getItem('config_token');

            if (fileInput.files.length === 0) {
                alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    headers: { 'Authorization': token },
                    body: formData
                });

                if (response.ok) {
                    alert("ä¸Šä¼ æˆåŠŸï¼");
                } else {
                    const error = await response.json();
                    alert("å¤±è´¥: " + (error.message));
                }
            } catch (err) {
                alert("ç½‘ç»œé”™è¯¯");
            }
        }

        async function handleRestart() {
            const token = localStorage.getItem('config_token');

            try {
                const response = await fetch('/restart', {
                    method: 'GET',
                    headers: { 'Authorization': token }
                });

                if (response.ok) {
                    alert("ä»£ç†æœåŠ¡å·²é‡å¯ï¼");
                } else {
                    const error = await response.json();
                    alert("å¤±è´¥: " + (error.message));
                }
            } catch (err) {
                alert("ç½‘ç»œé”™è¯¯");
            }
        }
    </script>
</body>
</html>